{% comment %}
  Renders recommended products in the cart drawer based on
  custom.recommended_product metafield from cart items.

  Usage:
  {% render 'cart-drawer-recommended' %}
{% endcomment %}

{%- if cart.item_count > 0 -%}
  {%- liquid
    # Collect all recommended products from cart items
    assign recommended_products = ''
    assign cart_product_ids = ''

    # First, collect all product IDs currently in cart
    for item in cart.items
      assign cart_product_ids = cart_product_ids | append: item.product.id | append: ','
    endfor

    # Collect recommended products from each cart item
    assign all_recommended = array
    for item in cart.items
      if item.product.metafields.custom.recommended_product != blank
        for rec_product in item.product.metafields.custom.recommended_product.value
          # Check if product is not already in cart and not already added to recommendations
          assign rec_id_string = rec_product.id | append: ','
          assign already_in_cart = cart_product_ids | contains: rec_id_string
          assign already_recommended = recommended_products | contains: rec_id_string

          unless already_in_cart or already_recommended
            assign recommended_products = recommended_products | append: rec_id_string
            assign all_recommended = all_recommended | concat: rec_product
          endunless
        endfor
      endif
    endfor
  -%}

  {%- if recommended_products != '' -%}
    <div class="cart-drawer-recommended">
      <div class="cart-drawer-recommended__header">
        <h3 class="cart-drawer-recommended__title">You May Also Like</h3>
      </div>
      <div class="cart-drawer-recommended__products">
        {%- for item in cart.items -%}
          {%- if item.product.metafields.custom.recommended_product != blank -%}
            {%- for rec_product in item.product.metafields.custom.recommended_product.value -%}
              {%- liquid
                # Check if this product should be shown
                assign rec_id_check = rec_product.id | append: ','
                assign skip_product = cart_product_ids | contains: rec_id_check
              -%}
              {%- unless skip_product -%}
                {%- liquid
                  # Remove from cart_product_ids check to avoid showing duplicates
                  # We'll track shown products by adding to cart_product_ids
                  assign cart_product_ids = cart_product_ids | append: rec_id_check
                -%}
                <div class="cart-drawer-recommended__item">
                  <a href="{{ rec_product.url }}" class="cart-drawer-recommended__link">
                    {%- if rec_product.featured_image != blank -%}
                      <div class="cart-drawer-recommended__image">
                        <img
                          src="{{ rec_product.featured_image | image_url: width: 200 }}"
                          alt="{{ rec_product.featured_image.alt | escape }}"
                          width="100"
                          height="100"
                          loading="lazy"
                        >
                      </div>
                    {%- endif -%}
                    <div class="cart-drawer-recommended__details">
                      <p class="cart-drawer-recommended__product-title">{{ rec_product.title }}</p>
                      <p class="cart-drawer-recommended__price">
                        {%- if rec_product.compare_at_price > rec_product.price -%}
                          <s class="cart-drawer-recommended__compare-price">{{ rec_product.compare_at_price | money }}</s>
                        {%- endif -%}
                        <span>{{ rec_product.price | money }}</span>
                      </p>
                    </div>
                  </a>
                  {%- if rec_product.available -%}
                    {%- if rec_product.variants.size == 1 -%}
                      <button
                        type="button"
                        class="cart-drawer-recommended__add-btn button button--secondary"
                        data-variant-id="{{ rec_product.variants.first.id }}"
                        onclick="addRecommendedToCart(this)"
                      >
                        Add
                      </button>
                    {%- else -%}
                      <a
                        href="{{ rec_product.url }}"
                        class="cart-drawer-recommended__add-btn button button--secondary"
                      >
                        View
                      </a>
                    {%- endif -%}
                  {%- else -%}
                    <span class="cart-drawer-recommended__sold-out">Sold Out</span>
                  {%- endif -%}
                </div>
              {%- endunless -%}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>

    <script>
      function addRecommendedToCart(button) {
        const variantId = button.dataset.variantId;
        if (!variantId) return;

        button.disabled = true;
        button.textContent = 'Adding...';

        const formData = {
          items: [{
            id: parseInt(variantId),
            quantity: 1
          }]
        };

        fetch(window.Shopify.routes.root + 'cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
          // Refresh the cart drawer
          fetch(window.Shopify.routes.root + 'cart.js')
            .then(res => res.json())
            .then(cart => {
              // Update cart count in header
              const cartCountElements = document.querySelectorAll('.cart-count-bubble span[aria-hidden="true"]');
              cartCountElements.forEach(el => {
                el.textContent = cart.item_count;
              });

              // Refresh cart drawer content
              fetch(window.location.pathname + '?sections=cart-drawer')
                .then(res => res.json())
                .then(sections => {
                  const cartDrawer = document.querySelector('cart-drawer');
                  if (cartDrawer && sections['cart-drawer']) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(sections['cart-drawer'], 'text/html');

                    // Update cart items
                    const newCartItems = doc.querySelector('cart-drawer-items');
                    const currentCartItems = cartDrawer.querySelector('cart-drawer-items');
                    if (newCartItems && currentCartItems) {
                      currentCartItems.innerHTML = newCartItems.innerHTML;
                    }

                    // Update footer
                    const newFooter = doc.querySelector('.drawer__footer');
                    const currentFooter = cartDrawer.querySelector('.drawer__footer');
                    if (newFooter && currentFooter) {
                      currentFooter.innerHTML = newFooter.innerHTML;
                    }

                    // Update recommended products
                    const newRecommended = doc.querySelector('.cart-drawer-recommended');
                    const currentRecommended = cartDrawer.querySelector('.cart-drawer-recommended');
                    if (newRecommended && currentRecommended) {
                      currentRecommended.innerHTML = newRecommended.innerHTML;
                    } else if (newRecommended && !currentRecommended) {
                      const cartItemsWrapper = cartDrawer.querySelector('.drawer__cart-items-wrapper');
                      if (cartItemsWrapper) {
                        cartItemsWrapper.insertAdjacentHTML('afterend', newRecommended.outerHTML);
                      }
                    } else if (!newRecommended && currentRecommended) {
                      currentRecommended.remove();
                    }

                    // Remove is-empty class
                    cartDrawer.classList.remove('is-empty');
                  }
                });
            });
        })
        .catch(error => {
          console.error('Error adding to cart:', error);
          button.disabled = false;
          button.textContent = 'Add';
        });
      }
    </script>
  {%- endif -%}
{%- endif -%}
