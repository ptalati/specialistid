{%- comment -%}
  Cart Notification Recommended Products Snippet
  Displays recommended products from cart items' custom.recommended_product metafield

  Usage:
  {% render 'cart-notification-recommended' %}
{%- endcomment -%}

{%- if cart != empty -%}
  {%- liquid
    assign cart_product_ids = ''
    for item in cart.items
      assign cart_product_ids = cart_product_ids | append: item.product.id | append: ','
    endfor

    assign shown_product_ids = cart_product_ids
    assign has_recommendations = false

    for item in cart.items
      if item.product.metafields.custom.recommended_product != blank
        for rec_product in item.product.metafields.custom.recommended_product.value
          assign rec_id_check = rec_product.id | append: ','
          if shown_product_ids contains rec_id_check
            assign already_shown = true
          else
            assign already_shown = false
          endif
          unless already_shown
            assign has_recommendations = true
            break
          endunless
        endfor
      endif
      if has_recommendations
        break
      endif
    endfor
  -%}

  {%- if has_recommendations -%}
    <div class="cart-notification-recommended">
      <h4 class="cart-notification-recommended__title">You May Also Like</h4>
      <div class="cart-notification-recommended__slider">
        <div class="cart-notification-recommended__products">
          {%- for item in cart.items -%}
            {%- if item.product.metafields.custom.recommended_product != blank -%}
              {%- for rec_product in item.product.metafields.custom.recommended_product.value -%}
                {%- liquid
                  assign rec_id_check = rec_product.id | append: ','
                  if shown_product_ids contains rec_id_check
                    assign skip_product = true
                  else
                    assign skip_product = false
                  endif
                -%}
                {%- unless skip_product -%}
                  {%- assign shown_product_ids = shown_product_ids | append: rec_id_check -%}
                  <div class="cart-notification-recommended__item">
                    {%- if rec_product.featured_image != blank -%}
                      <a href="{{ rec_product.url }}" class="cart-notification-recommended__image-link">
                        <div class="cart-notification-recommended__image global-media-settings">
                          <img
                            src="{{ rec_product.featured_image | image_url: width: 140 }}"
                            alt="{{ rec_product.featured_image.alt | escape }}"
                            width="70"
                            height="{{ 70 | divided_by: rec_product.featured_image.aspect_ratio | ceil }}"
                            loading="lazy"
                          >
                        </div>
                      </a>
                    {%- endif -%}
                    <div class="cart-notification-recommended__details">
                      <a href="{{ rec_product.url }}" class="cart-notification-recommended__product-title h4">
                        {{ rec_product.title }}
                      </a>
                      <p class="cart-notification-recommended__price">
                        {%- if rec_product.compare_at_price > rec_product.price -%}
                          <s class="cart-notification-recommended__compare-price">{{ rec_product.compare_at_price | money }}</s>
                        {%- endif -%}
                        <span>{{ rec_product.price | money }}</span>
                      </p>
                      {%- if rec_product.available -%}
                        {%- if rec_product.variants.size == 1 -%}
                          <button
                            type="button"
                            class="cart-notification-recommended__add-btn button button--secondary"
                            data-variant-id="{{ rec_product.variants.first.id }}"
                            onclick="addRecommendedProductToCart(this)"
                          >
                            Add to Cart
                          </button>
                        {%- else -%}
                          <a
                            href="{{ rec_product.url }}"
                            class="cart-notification-recommended__add-btn button button--secondary"
                          >
                            View Options
                          </a>
                        {%- endif -%}
                      {%- else -%}
                        <span class="cart-notification-recommended__sold-out">Sold Out</span>
                      {%- endif -%}
                    </div>
                  </div>
                {%- endunless -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
        </div>
        <button type="button" class="cart-notification-recommended__nav cart-notification-recommended__nav--prev" aria-label="Previous" style="display: none;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
        <button type="button" class="cart-notification-recommended__nav cart-notification-recommended__nav--next" aria-label="Next" style="display: none;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>
      </div>
    </div>
    <script>
      (function() {
        const slider = document.querySelector('.cart-notification-recommended__slider');
        if (!slider) return;

        const products = slider.querySelector('.cart-notification-recommended__products');
        const prevBtn = slider.querySelector('.cart-notification-recommended__nav--prev');
        const nextBtn = slider.querySelector('.cart-notification-recommended__nav--next');
        const items = products.querySelectorAll('.cart-notification-recommended__item');

        if (items.length <= 1) return;

        // Show navigation if more than 1 item
        prevBtn.style.display = 'flex';
        nextBtn.style.display = 'flex';

        let currentIndex = 0;
        const itemWidth = items[0].offsetWidth + 16; // width + gap

        function updateSlider() {
          products.style.transform = `translateX(-${currentIndex * itemWidth}px)`;
          prevBtn.disabled = currentIndex === 0;
          nextBtn.disabled = currentIndex >= items.length - 1;
        }

        prevBtn.addEventListener('click', () => {
          if (currentIndex > 0) {
            currentIndex--;
            updateSlider();
          }
        });

        nextBtn.addEventListener('click', () => {
          if (currentIndex < items.length - 1) {
            currentIndex++;
            updateSlider();
          }
        });

        updateSlider();
      })();
    </script>
  {%- endif -%}
{%- endif -%}
